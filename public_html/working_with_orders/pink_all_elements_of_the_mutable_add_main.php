<?php#========================================================# Добавление выбранного товара в заказ в зависимости от типа#========================================================session_start();if(empty($_SESSION['user']) OR ($_SESSION['state'] != 'admin' AND $_SESSION['state'] != 'designer' AND $_SESSION['state'] != 'workshop')){    echo "Доступ запрещен";    die;}require_once '../connect_to_database.php';require_once "../global_functions.php";//  -------------------------------//  для проверки на создание заказа$id_pink_order = $_POST['id_pink_order'];$sql = "SELECT * FROM `orders_main_info` WHERE `id_pink_order` = '$id_pink_order'";$select = mysqli_query($connect, $sql);$select = mysqli_fetch_assoc($select);$now_state = $select['pink_state'];if($select['executor_id'] != $_SESSION['id_user'] and $_SESSION['state'] != 'admin') {    echo "Доступ запрещен";    die;}// --------------------------------------#$id_paragraph = $_POST['id_paragraph'];if(!empty($_POST['description'])){    $description = $_POST['description'];} else {    ?>    <!DOCTYPE html>    <html>    <head>        <meta name="viewport" content="width=device-width, initial-scale=1">        <meta charset="utf-8">        <link rel="stylesheet" href="../assets/css/style.css">        <link rel="stylesheet" href="../assets/css/style_messag.css">        <link rel="stylesheet" href="../assets/css/full_info_css.css">        <title>Pink</title>        <script src="https://kit.fontawesome.com/58ebeca16e.js" crossorigin="anonymous"></script>        <script src="../assets/script/app.js" defer></script>    </head>    <body>    <header class="header">        <?php        include('../header.php');        ?>    </header>    <div class="find_info">        <div class="info_about_update_state">            <h1>Ошибка</h1>            <div class="search_info_error"> Вы не выбрали товар</div>            <a href="pink_all_elements_of_the_mutable.php?id_pink_order=<?= $id_pink_order ?>" class="btn_back_to_msg">Вернуться</a>        </div>    </div>    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>    </body>    </html>    <?php    die;}if(!empty($_POST['size'])){    $size = $_POST['size'];} else{    $size = NULL;}$quantity = $_POST['quantity'];$quantity = floatval($quantity);// указываем из какой таблицы брать данные$tb = $_POST['tb'];if($tb != 'services'){    $room = $_POST['room'];    if($tb == 1) {        $from = 'cloth';        $type_prod =  'cloth';        $type_name_price = 'price';        $type_name_collection = 'collection';        $provider = 'provider';    } else if ($tb == 2) {        $from = 'cornices';        $type_prod =  'cornices';        $type_name_price = 'price';        $type_name_collection = 'type';        $provider = 'provider';    }else if ($tb == 3) {        $from = 'blinds';        $type_prod =  'blinds';        $type_name_price = 'price';        $type_name_collection = 'type';        $provider = 'provider';    }else if ($tb == 4) {        $from = 'furniture';        $type_prod =  'furniture';        $type_name_price = 'price';        $type_name_collection = 'collection';        $provider = 'provider';    }    if((is_int($quantity) or is_float($quantity)) and $quantity > 0){        //$sql = "SELECT * FROM `products` WHERE `id` = '$description'";        $sql = "SELECT * FROM `$from` WHERE `id` = '$description'";        $select = mysqli_query($connect, $sql);        $select = mysqli_fetch_assoc($select);        $price = show_normal_price($connect, $select['price'], $select['provider'], $select['currency'], $from);        $description = $select['title'] . "|" . $select[$type_name_collection];        $supplier = $select[$provider];        $last_paragraph = "SELECT * FROM `description_of_pink_pages` WHERE `id_pink_order` = '$id_pink_order' AND `room` = '$room' ORDER BY id_paragraph DESC LIMIT 1";        $select = mysqli_query($connect, $last_paragraph);        $select = mysqli_fetch_assoc($select);        if($select != NULL) {            $last_paragraph = $select['id_paragraph'];            $last_paragraph += 1;            if($now_state == 'Возврат дизайнеру' or $now_state == 'Перевыбор ткани в салоне' or $now_state == 'Возврат ткани'){                mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`, `additional_info`) VALUES (NULL, '$id_pink_order', '$room', '$last_paragraph', '$description', '$size', '$quantity', '$price', '$type_prod', 0, '$supplier', 'Заменено')");                mysqli_query($connect, "DELETE FROM `description_of_pink_pages` WHERE `id_paragraph` = 0 AND `id_pink_order` = '$id_pink_order' AND `room` = '$room'");            }else {                mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`) VALUES (NULL, '$id_pink_order', '$room', '$last_paragraph', '$description', '$size', '$quantity', '$price', '$type_prod', 0, '$supplier')");                mysqli_query($connect, "DELETE FROM `description_of_pink_pages` WHERE `id_paragraph` = 0 AND `id_pink_order` = '$id_pink_order' AND `room` = '$room'");                //mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`) VALUES (NULL, '$id_pink_order', '$last_paragraph', '$description', '$size', '$quantity', '$price', '$type_prod')");            }            header("Location: pink_all_elements_of_the_mutable.php?id_pink_order=$id_pink_order");        }    } else {        ?>        <!DOCTYPE html>        <html>        <head>            <meta name="viewport" content="width=device-width, initial-scale=1">            <meta charset="utf-8">            <link rel="stylesheet" href="../assets/css/style.css">            <link rel="stylesheet" href="../assets/css/style_messag.css">            <link rel="stylesheet" href="../assets/css/full_info_css.css">            <title>Pink</title>            <script src="https://kit.fontawesome.com/58ebeca16e.js" crossorigin="anonymous"></script>            <script src="../assets/script/app.js" defer></script>        </head>        <body>        <header class="header">            <?php            include('../header.php');            ?>        </header>        <div class="find_info">            <div class="info_about_update_state">                <h1>Ошибка</h1>                <div class="search_info_error"> Количество должно быть больше 0</div>                <a href="pink_all_elements_of_the_mutable.php?id_pink_order=<?= $id_pink_order ?>" class="btn_back_to_msg">Вернуться</a>            </div>        </div>        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>        </body>        </html>        <?php    }} else {    if((is_int($quantity) or is_float($quantity)) and $quantity > 0){        //$sql = "SELECT * FROM `products` WHERE `id` = '$description'";        $room = $_POST['room'];        if($room == '--'){            $sql = "SELECT * FROM `services` WHERE `id` = '$description'";            $select = mysqli_query($connect, $sql);            $select = mysqli_fetch_assoc($select);            $price = $select['price'];            $description = $select['title'];            $type = $select['service_type'];            if($type == 'delivery' or $type == 'install'){                $sql_address = "SELECT `address_additional` FROM `orders_main_info` WHERE `id_pink_order` = '$id_pink_order'";                $select_address = mysqli_query($connect, $sql_address);                $select_address = mysqli_fetch_assoc($select_address);                $address = $select_address['address_additional'];                if(empty($address)){                    ?>                    <!DOCTYPE html>                    <html>                    <head>                        <meta name="viewport" content="width=device-width, initial-scale=1">                        <meta charset="utf-8">                        <link rel="stylesheet" href="../assets/css/style.css">                        <link rel="stylesheet" href="../assets/css/style_messag.css">                        <link rel="stylesheet" href="../assets/css/full_info_css.css">                        <title>Pink</title>                        <script src="https://kit.fontawesome.com/58ebeca16e.js" crossorigin="anonymous"></script>                        <script src="../assets/script/app.js" defer></script>                    </head>                    <body>                    <header class="header">                        <?php                        include('../header.php');                        ?>                    </header>                    <div class="find_info">                        <div class="info_about_update_state">                            <h1>Ошибка</h1>                            <div class="search_info_error"> Необходимо указать адрес</div>                            <a href="pink_all_elements_of_the_mutable.php?id_pink_order=<?= $id_pink_order ?>" class="btn_back_to_msg">Вернуться</a>                        </div>                    </div>                    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>                    </body>                    </html>                    <?php                    die;                }            }            $last_paragraph = "SELECT * FROM `description_of_pink_pages` WHERE `id_pink_order` = '$id_pink_order' AND `room` = '--' ORDER BY id_paragraph DESC LIMIT 1";            $select = mysqli_query($connect, $last_paragraph);            $select = mysqli_fetch_assoc($select);            if($select != NULL) {                $last_paragraph = $select['id_paragraph'];                $last_paragraph += 1;                if($now_state == 'Возврат дизайнеру' or $now_state == 'Перевыбор ткани в салоне' or $now_state == 'Возврат ткани'){                    mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`, `additional_info`) VALUES (NULL, '$id_pink_order', '--', '$last_paragraph', '$description', '$size', '$quantity', '$price', 'services', 0, 'mv', 'Заменено')");                }else {                    mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`) VALUES (NULL, '$id_pink_order', '--', '$last_paragraph', '$description', '$size', '$quantity', '$price', 'services', 0, 'mv')");                }                header("Location: pink_all_elements_of_the_mutable.php?id_pink_order=$id_pink_order");            }else {                if($now_state == 'Возврат дизайнеру' or $now_state == 'Перевыбор ткани в салоне' or $now_state == 'Возврат ткани'){                    mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`, `additional_info`) VALUES (NULL, '$id_pink_order', '--', '1', '$description', '$size', '$quantity', '$price', 'services', 0, 'mv', 'Заменено')");                }else {                    mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`) VALUES (NULL, '$id_pink_order', '--', '1', '$description', '$size', '$quantity', '$price', 'services', 0, 'mv')");                }                header("Location: pink_all_elements_of_the_mutable.php?id_pink_order=$id_pink_order");            }        }else{            $sql = "SELECT * FROM `sewing_salon` WHERE `id` = '$description'";            $select = mysqli_query($connect, $sql);            $select = mysqli_fetch_assoc($select);            $price = $select['price'];            $description = $select['title'];            $type = 'sewing';            if(!empty($_POST['description_2'])) {                $description_2 = $_POST['description_2'];                $sql = "SELECT * FROM `difficult_elements` WHERE `id` = '$description_2'";                $select = mysqli_query($connect, $sql);                $select = mysqli_fetch_assoc($select);                $price_2 = ($price * ($select['percent']/100));                $description_2 = $select['title'];                $type_2 = 'modification';            }            $last_paragraph = "SELECT * FROM `description_of_pink_pages` WHERE `id_pink_order` = '$id_pink_order' AND `room` = '$room' ORDER BY id_paragraph DESC LIMIT 1";            $select = mysqli_query($connect, $last_paragraph);            $select = mysqli_fetch_assoc($select);            if($select != NULL) {                $last_paragraph = $select['id_paragraph'];                $last_paragraph += 1;                if($now_state == 'Возврат дизайнеру' or $now_state == 'Перевыбор ткани в салоне' or $now_state == 'Возврат ткани'){                    mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`, `additional_info`) VALUES (NULL, '$id_pink_order', '$room', '$last_paragraph', '$description', '$size', '$quantity', '$price', '$type', 0, 'mv', 'Заменено')");                    mysqli_query($connect, "DELETE FROM `description_of_pink_pages` WHERE `id_paragraph` = 0 AND `id_pink_order` = '$id_pink_order' AND `room` = '$room'");                }else {                    mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`) VALUES (NULL, '$id_pink_order', '$room', '$last_paragraph', '$description', '$size', '$quantity', '$price', '$type', 0, 'mv')");                    mysqli_query($connect, "DELETE FROM `description_of_pink_pages` WHERE `id_paragraph` = 0 AND `id_pink_order` = '$id_pink_order' AND `room` = '$room'");                }                if(!empty($_POST['description_2'])){                    $last_paragraph += 1;                    if($now_state == 'Возврат дизайнеру' or $now_state == 'Перевыбор ткани в салоне' or $now_state == 'Возврат ткани'){                        mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`, `additional_info`) VALUES (NULL, '$id_pink_order', '$room', '$last_paragraph', '$description_2', '$size', '$quantity', '$price_2', '$type_2', 0, 'mv', 'Заменено')");                        mysqli_query($connect, "DELETE FROM `description_of_pink_pages` WHERE `id_paragraph` = 0 AND `id_pink_order` = '$id_pink_order' AND `room` = '$room'");                    }else {                        mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`) VALUES (NULL, '$id_pink_order', '$room', '$last_paragraph', '$description_2', '$size', '$quantity', '$price_2', '$type_2', 0, 'mv')");                        mysqli_query($connect, "DELETE FROM `description_of_pink_pages` WHERE `id_paragraph` = 0 AND `id_pink_order` = '$id_pink_order' AND `room` = '$room'");                    }                }                header("Location: pink_all_elements_of_the_mutable.php?id_pink_order=$id_pink_order");            }else {                if($now_state == 'Возврат дизайнеру' or $now_state == 'Перевыбор ткани в салоне' or $now_state == 'Возврат ткани'){                    mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`, `additional_info`) VALUES (NULL, '$id_pink_order', '$room', '1', '$description', '$size', '$quantity', '$price', '$type', 0, 'mv', 'Заменено')");                }else {                    mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`) VALUES (NULL, '$id_pink_order', '$room', '1', '$description', '$size', '$quantity', '$price', '$type', 0, 'mv')");                }                if(!empty($_POST['description_2'])){                    $last_paragraph += 1;                    if($now_state == 'Возврат дизайнеру' or $now_state == 'Перевыбор ткани в салоне' or $now_state == 'Возврат ткани'){                        mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`, `additional_info`) VALUES (NULL, '$id_pink_order', '$room', '1', '$description_2', '$size', '$quantity', '$price_2', '$type_2', 0, 'mv', 'Заменено')");                    }else {                        mysqli_query($connect, "INSERT INTO `description_of_pink_pages` (`id`, `id_pink_order`, `room`, `id_paragraph`, `description`, `size`, `quantity`, `price`, `category`, `supplier_price`, `provider`) VALUES (NULL, '$id_pink_order', '$room', '2', '$description_2', '$size', '$quantity', '$price_2', '$type_2', 0, 'mv')");                    }                }                header("Location: pink_all_elements_of_the_mutable.php?id_pink_order=$id_pink_order");            }        }    } else {        ?>        <!DOCTYPE html>        <html>        <head>            <meta name="viewport" content="width=device-width, initial-scale=1">            <meta charset="utf-8">            <link rel="stylesheet" href="../assets/css/style.css">            <link rel="stylesheet" href="../assets/css/style_messag.css">            <link rel="stylesheet" href="../assets/css/full_info_css.css">            <title>Pink</title>            <script src="https://kit.fontawesome.com/58ebeca16e.js" crossorigin="anonymous"></script>            <script src="../assets/script/app.js" defer></script>        </head>        <body>        <header class="header">            <?php            include('../header.php');            ?>        </header>        <div class="find_info">            <div class="info_about_update_state">                <h1>Ошибка</h1>                <div class="search_info_error"> Количество должно быть больше 0</div>                <a href="pink_all_elements_of_the_mutable.php?id_pink_order=<?= $id_pink_order ?>" class="btn_back_to_msg">Вернуться</a>            </div>        </div>        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>        </body>        </html>        <?php    }}